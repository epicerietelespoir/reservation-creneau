<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>R√©server un cr√©neau ‚Ä¢ √âpicerie T√©lespoir</title>

<!-- Firebase (compat pour site statique) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<!-- EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3.2.0/dist/email.min.js"></script>
<script>
  emailjs.init("q_q1Ymuq0qOD8IG6a"); // cl√© publique EmailJS
</script>

<style>
  body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 40px; }
  h1 { text-align: center; color: #273070; }
  .container { max-width: 500px; margin: auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); margin-bottom: 20px; }
  input, button { padding: 10px; margin: 8px 0; width: 100%; }
  .slot-btn { margin: 5px 0; background: #273070; color: white; border: none; border-radius: 5px; cursor: pointer; }
  .slot-btn:disabled { background: #ccc; cursor: not-allowed; }
  .red { background: #c0392b; color: white; }
</style>

</head>
<body>

<!-- FORMULAIRE UTILISATEUR -->
<div class="container">
  <h1>R√©server un cr√©neau</h1>
  <input type="text" id="prenom" placeholder="Pr√©nom" required>
  <input type="text" id="name" placeholder="Nom" required>
  <input type="email" id="email" placeholder="Email" required>
  <div id="slots"></div>
</div>

<!-- ADMIN -->
<div class="container">
  <h3>‚öôÔ∏è Admin (mot de passe requis)</h3>
  <button id="resetBtn" class="red">R√©initialiser tous les cr√©neaux</button>
  <input type="text" id="autoSlots" placeholder="Ex: Lundi 10h,Lundi 11h,Mardi 14h">
  <button id="addSlotsBtn">Ajouter les cr√©neaux</button>
</div>

<script>
  //Variables
  let slotsList = [];   
  let takenSlots = [];  

  //Init Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyDKpM_xwciFWOjHb18bONOO2N5c4jliQTM",
    authDomain: "creneaux-26.firebaseapp.com",
    databaseURL: "https://creneaux26-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "creneaux-26",
    storageBucket: "creneaux-26.appspot.com",
    messagingSenderId: "925270932823",
    appId: "1:925270932823:web:1b0c438422145e3c30d212"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  //Charger les cr√©neaux depuis Firebase
  function loadSlots() {
    db.ref('slots').once('value').then(snapshot => {
      const data = snapshot.val();
      slotsList = [];
      takenSlots = [];
      if(data){
        for(let slot in data){
          slotsList.push(slot);
          if(data[slot] !== false){ // true = pris
            takenSlots.push(slot);
          }
        }
      }
      renderSlots();
    });
  }

  //Affichage des cr√©neaux
  function renderSlots() {
    const div = document.getElementById("slots");
    div.innerHTML = "<h3>Cr√©neaux disponibles :</h3>";
    slotsList.forEach(slot => {
      const btn = document.createElement("button");
      btn.textContent = slot;
      btn.className = "slot-btn";
      btn.disabled = takenSlots.includes(slot);
      if(!btn.disabled) btn.onclick = () => reserve(slot);
      div.appendChild(btn);
    });
  }

  async function reserve(slot) {
    const prenom = document.getElementById("prenom").value.trim();
    const name = document.getElementById("name").value.trim();
    const email = document.getElementById("email").value.trim();
    if(!prenom || !name || !email){
      alert("Remplis tous les champs !");
      return;
    }

    const snap = await db.ref('slots/' + slot).get();
    if(snap.exists() && snap.val() !== false){
      alert("D√©sol√©, ce cr√©neau est d√©j√† pris !");
      loadSlots(); // recharge 
      return;
    }

    db.ref('slots/' + slot).set(true); //pris
    loadSlots(); 

    //Emails
    emailjs.send("service_98v3zye", "template_ii2jcrg", { name, prenom, email, slot });
    emailjs.send("service_98v3zye", "template_glyge5x", { name, prenom, email, slot });

    alert(`R√©serv√© üéâ : ${slot}`);
    document.querySelectorAll("input, button").forEach(el => el.disabled = true);
  }

  function askPassword(action){
    const pwd = prompt("Mot de passe admin ?");
    if(pwd === "Admin2026"){ 
      action();
    } else {
      alert("‚ùå Mot de passe incorrect !");
    }
  }

  // Ajouter des cr√©neaux
  document.getElementById("addSlotsBtn").onclick = () => {
    askPassword(() => {
      const slots = document.getElementById("autoSlots").value.split(",");
      slots.forEach(s => {
        const slot = s.trim();
        if(slot) db.ref('slots/' + slot).set(false); // libre
      });
      document.getElementById("autoSlots").value = "";
      alert("‚úÖ Cr√©neaux ajout√©s !");
      loadSlots();
    });
  };

  //R√©initialiser tous les cr√©neaux
  document.getElementById("resetBtn").onclick = () => {
    askPassword(() => {
      if(confirm("Es-tu s√ªr de r√©initialiser tous les cr√©neaux ?")){
        db.ref('slots').set(null).then(() => {
          alert("‚úÖ Tous les cr√©neaux ont √©t√© supprim√©s !");
          loadSlots();
        });
      }
    });
  };

  window.onload = () => {
    loadSlots();
  };

</script>

</body>
</html>
